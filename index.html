
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>球館分籤系統</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons (UMD) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #efefef;
            color: #474747;
            min-height: 100vh;
        }
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb {
            background: #d4d4d4;
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #a3a3a3;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.556.0",
    "react/": "https://aistudiocdn.com/react@^19.2.1/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        // lucide icons are available globally via lucide.icons
        
        // Defining Icons manually to ensure zero dependency issues
        const UsersIcon = ({className}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        );
        const LinkIcon = ({className}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
        );
        const UnlinkIcon = ({className}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m18.84 12.25 1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71"/><path d="m5.17 11.75-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71"/><line x1="8" x2="16" y1="2" y2="2"/><line x1="8" x2="16" y1="22" y2="22"/><line x1="2" x2="2" y1="8" y2="16"/><line x1="22" x2="22" y1="8" y2="16"/></svg> 
        );
        const Wand2Icon = ({className}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M19 14v4"/><path d="M10 2v2"/><path d="M7 8H3"/><path d="M21 16h-4"/><path d="M11 3H9"/></svg>
        );
        const RefreshCcwIcon = ({className}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
        );
        const InfoIcon = ({className}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
        );
        const AlertCircleIcon = ({className}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
        );
        const GripVerticalIcon = ({className}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>
        );
        const Trash2Icon = ({className}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
        );

        // --- Helper Functions ---
        const generateId = () => Math.random().toString(36).substr(2, 9);

        const parsePlayerInput = (text) => {
            const lines = text.split(/\n+/).filter((line) => line.trim());
            const players = [];

            lines.forEach((line, index) => {
                const cleanLine = line.trim();
                let name = "";
                let gender = null;

                if (cleanLine.endsWith("男")) {
                    name = cleanLine.slice(0, -1).trim();
                    gender = "男";
                } else if (cleanLine.endsWith("女")) {
                    name = cleanLine.slice(0, -1).trim();
                    gender = "女";
                } else {
                    const parts = cleanLine.split(/[\t\s]+/);
                    if (parts.length >= 2) {
                        const last = parts[parts.length - 1];
                        if (last === '男' || last === '女') {
                            gender = last;
                            name = parts.slice(0, -1).join(' ');
                        }
                    }
                }

                if (name && gender) {
                    players.push({
                        id: `p-${index}-${generateId()}`,
                        name,
                        gender,
                    });
                }
            });

            return players;
        };

        const GenderIcon = ({ gender }) => (
            <span className={`
                flex items-center justify-center w-5 h-5 rounded-full text-[10px] font-bold mr-2
                ${gender === "女" 
                    ? "bg-[#D4A2A6] text-white" 
                    : "bg-[#7F8F8E] text-white" 
                }
            `}>
                {gender === "女" ? "♀" : "♂"}
            </span>
        );

        const PlayerCard = ({ player, isSelected, onClick, bindingGroups, onDissolve }) => {
            const group = bindingGroups.find(g => g.id === player.groupId);
            
            const groupColors = [
                "border-[#D4A2A6] bg-[#fff0f2]",
                "border-[#7F8F8E] bg-[#f0f2f2]",
                "border-[#d4bca2] bg-[#fbf7f2]",
                "border-[#a2b8d4] bg-[#f2f6fb]",
                "border-[#bca2d4] bg-[#f8f2fb]",
            ];
            
            let colorIdx = 0;
            if (group) {
                const sum = group.id.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                colorIdx = sum % groupColors.length;
            }

            const activeStyle = group 
                ? groupColors[colorIdx]
                : "border-gray-200 bg-white hover:border-gray-400";

            const genderColor = player.gender === "女" ? "text-[#D4A2A6]" : "text-[#7F8F8E]";
            const borderColor = isSelected 
                ? (player.gender === "女" ? "!border-[#D4A2A6] ring-1 ring-[#D4A2A6]" : "!border-[#7F8F8E] ring-1 ring-[#7F8F8E]")
                : "";

            return (
                <div
                    onClick={onClick}
                    className={`
                        relative p-3 rounded border cursor-pointer transition-all duration-200 select-none
                        flex flex-col items-center justify-center min-h-[80px]
                        ${activeStyle}
                        ${borderColor}
                        ${isSelected ? "bg-opacity-50" : ""}
                    `}
                >
                    <div className="flex items-center gap-1 mb-1">
                            <span className={`text-[10px] font-bold ${genderColor}`}>
                                {player.gender === "女" ? "♀" : "♂"}
                            </span>
                    </div>
                    <div className={`text-sm font-medium truncate w-full text-center ${isSelected ? genderColor : "text-[#474747]"}`}>
                        {player.name}
                    </div>
                    
                    {group && !isSelected && (
                        <button 
                            onClick={(e) => { e.stopPropagation(); onDissolve(group.id); }}
                            className="absolute top-1 right-1 text-gray-300 hover:text-red-400 p-1"
                        >
                            <UnlinkIcon className="w-3 h-3" />
                        </button>
                    )}
                </div>
            );
        };

        const App = () => {
            const [inputText, setInputText] = useState("");
            const [players, setPlayers] = useState([]);
            const [bindingGroups, setBindingGroups] = useState([]);
            const [selectedPlayerIds, setSelectedPlayerIds] = useState([]);
            const [matchType, setMatchType] = useState("女網混排");
            const [teams, setTeams] = useState([]);
            const [view, setView] = useState("input");
            const [alertMsg, setAlertMsg] = useState(null);
            
            // Drag and Drop State
            const [draggedTeamIndex, setDraggedTeamIndex] = useState(null);

            const femalePlayers = players.filter(p => p.gender === '女');
            const malePlayers = players.filter(p => p.gender === '男');

            const handleImport = () => {
                const newPlayers = parsePlayerInput(inputText);
                if (newPlayers.length === 0 && inputText.trim().length > 0) {
                    setAlertMsg({ title: "格式錯誤", msg: "無法識別名單，請使用「姓名+性別」格式，例如：王小明男" });
                    return;
                }
                
                setPlayers(newPlayers);
                setBindingGroups([]);
                setSelectedPlayerIds([]);
                setTeams([]);
            };

            const toggleSelection = (playerId) => {
                const player = players.find(p => p.id === playerId);
                if (player?.groupId) return; 

                setSelectedPlayerIds((prev) =>
                prev.includes(playerId)
                    ? prev.filter((id) => id !== playerId)
                    : [...prev, playerId]
                );
            };

            const createGroup = () => {
                const count = selectedPlayerIds.length;
                
                if (![2, 3, 6].includes(count)) {
                    setAlertMsg({ 
                        title: "綁定人數限制", 
                        msg: `目前選擇了 ${count} 人。為了配合賽制（每隊6人），系統僅支援綁定 2人、3人 或 6人一組。` 
                    });
                    return;
                }

                const newGroupId = `g-${generateId()}`;
                const newGroup = {
                id: newGroupId,
                members: [...selectedPlayerIds],
                };

                setBindingGroups([...bindingGroups, newGroup]);
                setPlayers(players.map(p => selectedPlayerIds.includes(p.id) ? { ...p, groupId: newGroupId } : p));
                setSelectedPlayerIds([]);
            };

            const dissolveGroup = (groupId) => {
                setBindingGroups(bindingGroups.filter(g => g.id !== groupId));
                setPlayers(players.map(p => p.groupId === groupId ? { ...p, groupId: undefined } : p));
            };

            const drawTeams = () => {
                if (players.length < 12 || players.length > 18) {
                    setAlertMsg({ 
                        title: "人數限制", 
                        msg: `目前共有 ${players.length} 人。系統僅支援 12 至 18 人進行分籤。` 
                    });
                    return;
                }

                let buckets = [[], [], []]; 

                const fullGroups = bindingGroups.filter(g => g.members.length === 6);
                const partialGroups = bindingGroups.filter(g => g.members.length < 6);
                const boundIds = new Set(bindingGroups.flatMap(g => g.members));
                const soloPlayers = players.filter(p => !boundIds.has(p.id));

                const shuffledFullGroups = [...fullGroups].sort(() => Math.random() - 0.5);
                shuffledFullGroups.forEach((group, idx) => {
                    if (idx < 3) {
                        buckets[idx] = group.members.map(id => players.find(p => p.id === id));
                    }
                });

                const shuffledPartials = [...partialGroups].sort(() => Math.random() - 0.5);
                const countFemales = (ids) => ids.filter(id => players.find(p => p.id === id)?.gender === '女').length;

                const sortedPartials = shuffledPartials.sort((a, b) => {
                    const femaleA = countFemales(a.members);
                    const femaleB = countFemales(b.members);
                    if (femaleB !== femaleA) return femaleB - femaleA;
                    return b.members.length - a.members.length;
                });

                for (const group of sortedPartials) {
                    const groupSize = group.members.length;
                    let validBucketIndices = [0, 1, 2].filter(i => buckets[i].length + groupSize <= 6);
                    
                    if (validBucketIndices.length === 0) {
                        setAlertMsg({ title: "分組失敗", msg: "綁定群組過多，導致無法填滿隊伍。請嘗試解散部分 2人或3人 的群組。" });
                        return;
                    }

                    let bestBucketIndex = -1;
                    let minSizeInBucket = 999;
                    let minFemalesInBucket = 999;

                    const randomizedValidIndices = validBucketIndices.sort(() => Math.random() - 0.5);

                    for (const idx of randomizedValidIndices) {
                        const currentBucket = buckets[idx];
                        const currentFemales = currentBucket.filter(p => p.gender === '女').length;
                        const currentSize = currentBucket.length;

                        if (currentSize < minSizeInBucket) {
                            minSizeInBucket = currentSize;
                            minFemalesInBucket = currentFemales;
                            bestBucketIndex = idx;
                        } else if (currentSize === minSizeInBucket) {
                            if (currentFemales < minFemalesInBucket) {
                                minFemalesInBucket = currentFemales;
                                bestBucketIndex = idx;
                            }
                        }
                    }

                    const groupPlayers = group.members.map(id => players.find(p => p.id === id));
                    buckets[bestBucketIndex].push(...groupPlayers);
                }

                let remainingSolo = [...soloPlayers];
                const soloFemales = remainingSolo.filter(p => p.gender === "女").sort(() => Math.random() - 0.5);
                const soloMales = remainingSolo.filter(p => p.gender === "男").sort(() => Math.random() - 0.5);

                while (soloFemales.length > 0 || soloMales.length > 0) {
                    const currentSizes = buckets.map(b => b.length);
                    const minSize = Math.min(...currentSizes);

                    let candidates = buckets
                        .map((b, i) => ({ index: i, count: b.length, females: b.filter(p => p.gender === '女').length }))
                        .filter(s => s.count === minSize && s.count < 6);

                    if (candidates.length === 0) {
                        candidates = buckets
                            .map((b, i) => ({ index: i, count: b.length, females: b.filter(p => p.gender === '女').length }))
                            .filter(s => s.count < 6);
                    }

                    if (candidates.length === 0) break;

                    candidates.sort((a, b) => {
                        if (a.females !== b.females) return a.females - b.females;
                        return Math.random() - 0.5;
                    });

                    const targetSlot = candidates[0];
                    const bucket = buckets[targetSlot.index];

                    let charToAdd;

                    if (matchType === "女網混排") {
                        if (soloFemales.length > 0) {
                            charToAdd = soloFemales.shift();
                        } else {
                            charToAdd = soloMales.shift();
                        }
                    } else {
                        const pool = [...soloFemales, ...soloMales];
                        if (pool.length > 0) {
                            const randIdx = Math.floor(Math.random() * pool.length);
                            charToAdd = pool[randIdx];
                            if (charToAdd.gender === '女') {
                                const idx = soloFemales.findIndex(p => p.id === charToAdd.id);
                                if (idx > -1) soloFemales.splice(idx, 1);
                            } else {
                                const idx = soloMales.findIndex(p => p.id === charToAdd.id);
                                if (idx > -1) soloMales.splice(idx, 1);
                            }
                        }
                    }
                    
                    if (charToAdd) {
                        bucket.push(charToAdd);
                    }
                }

                setTeams([
                    { id: "A", name: "A 隊", members: buckets[0] },
                    { id: "B", name: "B 隊", members: buckets[1] },
                    { id: "C", name: "C 隊", members: buckets[2] },
                ]);
                setView("results");
            };

            // Drag and Drop Logic
            const handleDragStart = (e, index) => {
                setDraggedTeamIndex(index);
                e.dataTransfer.effectAllowed = "move";
            };

            const handleDragOver = (e, index) => {
                e.preventDefault(); 
                if (draggedTeamIndex === null || draggedTeamIndex === index) return;
            };

            const handleDrop = (e, targetIndex) => {
                e.preventDefault();
                if (draggedTeamIndex === null) return;

                const newTeams = [...teams];
                const draggedTeam = newTeams[draggedTeamIndex];
                
                newTeams.splice(draggedTeamIndex, 1);
                newTeams.splice(targetIndex, 0, draggedTeam);

                // Relabel logic to keep A/B/C static
                const relabeledTeams = newTeams.map((team, idx) => ({
                    ...team,
                    id: idx === 0 ? "A" : idx === 1 ? "B" : "C",
                    name: idx === 0 ? "A 隊" : idx === 1 ? "B 隊" : "C 隊",
                }));

                setTeams(relabeledTeams);
                setDraggedTeamIndex(null);
            };

            return (
                <div className="min-h-screen pb-20 font-sans text-[#474747] bg-[#efefef]">
                {/* Header */}
                <header className="pt-10 pb-8 px-4 text-center">
                    <h1 className="text-3xl font-bold mb-2 tracking-wide text-[#474747] flex items-center justify-center gap-2">
                        球館臨打分籤系統
                    </h1>
                    <p className="text-[#888888] text-sm font-medium tracking-wider">SMART DRAW SYSTEM</p>
                </header>

                {/* Main Content */}
                <main className="max-w-4xl mx-auto px-4">
                    
                    {/* VIEW: INPUT & CONFIG */}
                    {view === "input" && (
                        <div className="space-y-6 animate-fade-in">
                            {/* 1. Import Section */}
                            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-lg font-bold flex items-center gap-2 text-[#474747]">
                                        <UsersIcon className="w-5 h-5 text-[#474747]" />
                                        參加者名單 ({players.length}人)
                                    </h2>
                                    {players.length > 0 && (
                                        <button 
                                            onClick={() => { setPlayers([]); setInputText(""); setBindingGroups([]); }}
                                            className="text-xs text-gray-400 hover:text-[#D4A2A6] transition-colors"
                                        >
                                            清除全部
                                        </button>
                                    )}
                                </div>
                            
                                <div className="relative">
                                    <textarea
                                        className="w-full h-32 p-4 border border-gray-200 rounded-lg focus:ring-1 focus:ring-[#474747] focus:border-[#474747] outline-none resize-none text-sm bg-[#fafafa] transition-all text-[#474747] placeholder-gray-400"
                                        placeholder="貼上名單（每行一位，格式：王小明男 或 Amy 女）..."
                                        value={inputText}
                                        onChange={(e) => setInputText(e.target.value)}
                                        onBlur={handleImport} 
                                    />
                                    <div className="absolute bottom-3 right-3">
                                        <button 
                                            onClick={handleImport}
                                            className="bg-[#474747] text-white px-4 py-1.5 rounded text-xs font-bold hover:bg-[#2d2d2d] transition tracking-wide"
                                        >
                                            更新名單
                                        </button>
                                    </div>
                                </div>
                                <p className="text-xs text-gray-400 mt-2 text-right">支援 12 ~ 18 人分籤</p>
                            </div>

                            {/* 2. Player Interaction Area */}
                            {players.length > 0 && (
                                <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                    
                                    {/* Stats Bar */}
                                    <div className="flex items-center justify-between bg-[#f9f9f9] rounded-lg p-3 mb-6 border border-gray-100">
                                        <div className="flex items-center gap-4">
                                            <div className="text-sm font-bold text-[#474747]">
                                                總計 <span className="text-lg">{players.length}</span> 人
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-4 text-sm">
                                            <div className="flex items-center gap-1 font-medium text-[#7F8F8E]">
                                                <span>♂</span>
                                                <span>{malePlayers.length} 男</span>
                                            </div>
                                            <div className="flex items-center gap-1 font-medium text-[#D4A2A6]">
                                                <span>♀</span>
                                                <span>{femalePlayers.length} 女</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-4 gap-2">
                                        <h2 className="text-lg font-bold text-[#474747] flex items-center gap-2">
                                            <LinkIcon className="w-5 h-5 text-[#474747]" />
                                            綁定隊友
                                        </h2>
                                        <div className="text-xs text-[#888] bg-[#f5f5f5] px-3 py-1 rounded-full font-medium">
                                            {selectedPlayerIds.length > 0 ? `已選擇 ${selectedPlayerIds.length} 人` : "點擊球員以選取，支援 2/3/6 人綁定"}
                                        </div>
                                    </div>

                                    {/* Female Section */}
                                    {femalePlayers.length > 0 && (
                                        <div className="mb-6">
                                            <h3 className="text-sm font-bold text-[#D4A2A6] mb-2 flex items-center justify-between border-l-4 border-[#D4A2A6] pl-2">
                                                <span>女生</span>
                                                <span className="text-xs bg-[#D4A2A6]/10 px-2 py-0.5 rounded">共 {femalePlayers.length} 女</span>
                                            </h3>
                                            <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3">
                                                {femalePlayers.map((player) => (
                                                    <PlayerCard 
                                                        key={player.id} 
                                                        player={player} 
                                                        isSelected={selectedPlayerIds.includes(player.id)}
                                                        onClick={() => toggleSelection(player.id)}
                                                        bindingGroups={bindingGroups}
                                                        onDissolve={dissolveGroup}
                                                    />
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* Male Section */}
                                    {malePlayers.length > 0 && (
                                        <div>
                                            <h3 className="text-sm font-bold text-[#7F8F8E] mb-2 flex items-center justify-between border-l-4 border-[#7F8F8E] pl-2">
                                                <span>男生</span>
                                                <span className="text-xs bg-[#7F8F8E]/10 px-2 py-0.5 rounded">共 {malePlayers.length} 男</span>
                                            </h3>
                                            <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3">
                                                {malePlayers.map((player) => (
                                                    <PlayerCard 
                                                        key={player.id} 
                                                        player={player} 
                                                        isSelected={selectedPlayerIds.includes(player.id)}
                                                        onClick={() => toggleSelection(player.id)}
                                                        bindingGroups={bindingGroups}
                                                        onDissolve={dissolveGroup}
                                                    />
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Action Bar for Binding */}
                                    <div className={`mt-6 flex justify-end transition-all duration-300 ${selectedPlayerIds.length > 0 ? "opacity-100 translate-y-0" : "opacity-0 translate-y-2 pointer-events-none"}`}>
                                        <button
                                            onClick={createGroup}
                                            className="flex items-center gap-2 bg-[#474747] text-white px-6 py-2 rounded shadow-md hover:bg-[#2d2d2d] transition text-sm font-bold tracking-wide"
                                        >
                                            <LinkIcon className="w-4 h-4" />
                                            綁定 {selectedPlayerIds.length} 人
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* Bound Groups Display (New) */}
                            {players.length > 0 && bindingGroups.length > 0 && (
                                <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 animate-fade-in">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-lg font-bold flex items-center gap-2 text-[#474747]">
                                            <UnlinkIcon className="w-5 h-5 text-[#474747]" />
                                            已綁定群組 ({bindingGroups.length})
                                        </h2>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {bindingGroups.map((group, index) => {
                                            const groupColors = [
                                                "border-[#D4A2A6] bg-[#fff0f2]",
                                                "border-[#7F8F8E] bg-[#f0f2f2]",
                                                "border-[#d4bca2] bg-[#fbf7f2]",
                                                "border-[#a2b8d4] bg-[#f2f6fb]",
                                                "border-[#bca2d4] bg-[#f8f2fb]",
                                            ];
                                            const colorClass = groupColors[index % groupColors.length];
                                            
                                            return (
                                                <div key={group.id} className={`p-4 rounded border relative ${colorClass}`}>
                                                    <div className="flex flex-wrap gap-2 pr-8">
                                                        {group.members.map(memberId => {
                                                            const p = players.find(player => player.id === memberId);
                                                            if (!p) return null;
                                                            return (
                                                                <span key={memberId} className="inline-flex items-center bg-white/60 px-2 py-1 rounded text-xs font-bold text-[#474747] border border-gray-100">
                                                                    <span className={`mr-1 ${p.gender === '女' ? 'text-[#D4A2A6]' : 'text-[#7F8F8E]'}`}>
                                                                        {p.gender === '女' ? '♀' : '♂'}
                                                                    </span>
                                                                    {p.name}
                                                                </span>
                                                            );
                                                        })}
                                                    </div>
                                                    <button 
                                                        onClick={() => dissolveGroup(group.id)}
                                                        className="absolute top-2 right-2 p-1.5 text-gray-400 hover:text-red-500 hover:bg-white rounded-full transition"
                                                        title="解散此群組"
                                                    >
                                                        <Trash2Icon className="w-4 h-4" />
                                                    </button>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {/* 3. Settings & Draw */}
                            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                <div className="flex flex-col md:flex-row gap-4 items-center justify-between">
                                    <div className="flex items-center gap-4 w-full md:w-auto">
                                        <label className="text-[#474747] font-bold text-sm whitespace-nowrap">賽制偏好</label>
                                        <div className="relative w-full md:w-48">
                                            <select 
                                                value={matchType}
                                                onChange={(e) => setMatchType(e.target.value)}
                                                className="w-full p-2.5 bg-[#f5f5f5] border border-gray-200 rounded text-sm text-[#474747] focus:outline-none focus:border-[#474747] appearance-none cursor-pointer"
                                            >
                                                <option value="女網混排">女網混排 (平衡女生)</option>
                                                <option value="男網混排">男網混排 (隨機分配)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button
                                        onClick={drawTeams}
                                        disabled={players.length === 0}
                                        className={`
                                            w-full md:w-auto flex items-center justify-center gap-2 px-8 py-3 rounded text-sm font-bold tracking-wider shadow-sm
                                            ${players.length >= 12 && players.length <= 18 ? "bg-[#474747] text-white hover:bg-[#2d2d2d]" : "bg-gray-200 text-gray-400 cursor-not-allowed"}
                                            transition-all duration-200
                                        `}
                                    >
                                        <Wand2Icon className="w-4 h-4" />
                                        開始分籤
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* VIEW: RESULTS */}
                    {view === "results" && (
                        <div className="space-y-6 pb-20 animate-fade-in">
                            <div className="flex items-center justify-between mb-4">
                                <button
                                    onClick={() => setView("input")}
                                    className="text-[#888] hover:text-[#474747] flex items-center gap-1 text-sm font-bold transition"
                                >
                                    ← 返回編輯
                                </button>
                                <button
                                    onClick={drawTeams}
                                    className="bg-[#474747] text-white px-4 py-2 rounded text-sm font-bold shadow-md hover:bg-[#2d2d2d] transition flex items-center gap-2"
                                >
                                    <RefreshCcwIcon className="w-4 h-4" />
                                    重新抽籤
                                </button>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 select-none">
                                {teams.map((team, idx) => (
                                    <div 
                                        key={team.id}
                                        draggable="true"
                                        onDragStart={(e) => handleDragStart(e, idx)}
                                        onDragOver={(e) => handleDragOver(e, idx)}
                                        onDrop={(e) => handleDrop(e, idx)}
                                        className={`
                                            bg-white rounded border border-gray-200 shadow-sm overflow-hidden flex flex-col h-full hover:shadow-md transition-all
                                            ${draggedTeamIndex === idx ? "opacity-40 border-dashed border-[#474747]" : ""}
                                            cursor-grab active:cursor-grabbing
                                        `}
                                    >
                                        {/* Team Header - Uniform Color */}
                                        <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-[#474747] text-white cursor-grab active:cursor-grabbing">
                                            <div className="flex items-center gap-2">
                                                <GripVerticalIcon className="w-4 h-4 text-gray-400" />
                                                <h3 className="text-xl font-bold tracking-wider">{team.name}</h3>
                                            </div>
                                            <span className="text-xs bg-white/20 px-2 py-0.5 rounded font-mono">{team.members.length}人</span>
                                        </div>

                                        {/* Team Members */}
                                        <div className="p-4 flex-1">
                                            <ul className="space-y-3">
                                                {team.members.sort((a,b) => (a.gender === '女' ? -1 : 1)).map((member) => (
                                                    <li key={member.id} className="flex items-center pb-2 border-b border-gray-50 last:border-0 last:pb-0">
                                                        <GenderIcon gender={member.gender} />
                                                        <span className="text-[#474747] font-medium text-sm">{member.name}</span>
                                                    </li>
                                                ))}
                                                {/* Empty slots placeholders if team is not full (e.g. only 4 people) */}
                                                {Array.from({ length: 6 - team.members.length }).map((_, i) => (
                                                    <li key={`empty-${i}`} className="flex items-center pb-2 border-b border-gray-50 last:border-0 last:pb-0 opacity-30">
                                                        <span className="w-5 h-5 rounded-full border border-dashed border-gray-400 mr-2"></span>
                                                        <span className="text-gray-400 font-medium text-sm italic">空位</span>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* Drag Hint */}
                            <p className="text-center text-xs text-gray-400 flex items-center justify-center gap-1">
                                <InfoIcon className="w-3 h-3" />
                                可拖曳卡片調整隊伍順序 (A / B / C)
                            </p>

                            {/* Match Info Card */}
                            <div className="bg-white border-l-4 border-[#474747] rounded shadow-sm p-5 mt-4 flex gap-4">
                                <InfoIcon className="w-6 h-6 text-[#474747] flex-shrink-0" />
                                <div>
                                    <h4 className="font-bold text-[#474747] mb-1">賽制說明</h4>
                                    <p className="text-sm text-[#888] leading-relaxed">
                                        A、B 兩隊先上場進行比賽。C 隊成員請協助計分，並準備下一輪輪替。
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                </main>
                
                {/* Alert Modal */}
                {alertMsg && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-[#474747]/80 backdrop-blur-sm animate-fade-in">
                        <div className="bg-white rounded p-6 w-full max-w-sm shadow-xl transform transition-all scale-100">
                            <div className="flex items-center gap-2 mb-3 text-[#474747]">
                                <AlertCircleIcon className="w-6 h-6" />
                                <h3 className="text-lg font-bold text-[#474747]">{alertMsg.title}</h3>
                            </div>
                            <p className="text-[#666] mb-6 text-sm leading-relaxed">{alertMsg.msg}</p>
                            <button 
                                onClick={() => setAlertMsg(null)}
                                className="w-full bg-[#474747] text-white font-bold py-2.5 rounded hover:bg-[#2d2d2d] transition tracking-wide text-sm"
                            >
                                我知道了
                            </button>
                        </div>
                    </div>
                )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
