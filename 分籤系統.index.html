<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>球館臨打分籤系統</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; text-align: center; border-radius: 16px 16px 0 0; }
        .header h1 { font-size: 26px; margin-bottom: 6px; }
        .header p { font-size: 14px; opacity: 0.9; }
        .content { padding: 24px; }
        .section { margin-bottom: 24px; }
        .section-title { font-size: 17px; font-weight: 600; color: #333; margin-bottom: 12px; padding-left: 10px; border-left: 4px solid #667eea; }
        .import-container { display: flex; gap: 10px; margin-bottom: 12px; }
        textarea { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; min-height: 160px; font-family: inherit; }
        textarea:focus { outline: none; border-color: #667eea; }
        .import-btn, .draw-btn { padding: 12px 20px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .import-btn { height: fit-content; }
        .draw-btn { width: 100%; }
        .binding-groups { margin-bottom: 12px; }
        .binding-group { background: #fbbf24; border-radius: 10px; padding: 14px; margin-bottom: 10px; }
        .binding-group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .binding-group-title { font-weight: 600; color: white; font-size: 14px; }
        .gender-stats { background: rgba(255,255,255,0.3); padding: 3px 10px; border-radius: 10px; font-size: 12px; color: white; font-weight: 600; }
        .remove-group-btn { background: rgba(255,255,255,0.3); color: white; border: none; padding: 5px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; }
        .binding-members { display: flex; flex-wrap: wrap; gap: 6px; }
        .binding-member { background: rgba(255,255,255,0.9); padding: 5px 8px; border-radius: 6px; display: flex; align-items: center; gap: 5px; font-size: 12px; }
        .binding-member .gender-badge { width: 16px; height: 16px; line-height: 16px; text-align: center; border-radius: 50%; font-size: 9px; font-weight: 600; }
        .gender-badge.female { background: #fce7f3; color: #ec4899; }
        .gender-badge.male { background: #dbeafe; color: #3b82f6; }
        .remove-member-btn { background: #ef4444; color: white; border: none; width: 14px; height: 14px; border-radius: 50%; font-size: 10px; cursor: pointer; line-height: 1; }
        .full-team-warning { margin-top: 6px; padding: 6px 10px; background: rgba(255,255,255,0.3); border-radius: 6px; color: white; font-size: 11px; }
        .players-display { display: flex; flex-direction: column; gap: 16px; }
        .gender-group { background: #f9fafb; border-radius: 10px; padding: 14px; border: 2px solid #e5e7eb; }
        .gender-group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb; }
        .gender-group-title { display: flex; align-items: center; gap: 6px; font-size: 15px; font-weight: 600; }
        .gender-icon { width: 26px; height: 26px; line-height: 26px; text-align: center; border-radius: 50%; font-size: 13px; }
        .gender-icon.female { background: #fce7f3; color: #ec4899; }
        .gender-icon.male { background: #dbeafe; color: #3b82f6; }
        .gender-count { font-size: 12px; font-weight: 600; color: #666; background: white; padding: 3px 10px; border-radius: 12px; }
        .players-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
        .player-chip { display: flex; align-items: center; gap: 6px; padding: 8px 10px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 13px; position: relative; }
        .player-chip.binding-active { background: #667eea; border-color: #667eea; }
        .player-chip.binding-active .player-name { color: white; }
        .player-chip.selectable { cursor: pointer; }
        .player-chip.selected { background: #ddd6fe; border-color: #7c3aed; }
        .player-chip .gender-badge { width: 20px; height: 20px; line-height: 20px; text-align: center; border-radius: 50%; font-size: 10px; font-weight: 600; }
        .player-chip .player-name { flex: 1; color: #333; font-weight: 500; }
        .link-icon { position: absolute; top: 4px; right: 4px; width: 16px; height: 16px; cursor: pointer; color: #9ca3af; }
        .add-icon { position: absolute; top: 4px; right: 4px; width: 18px; height: 18px; background: #10b981; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; }
        .binding-control-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 2px solid #e5e7eb; padding: 14px; display: none; justify-content: center; align-items: center; gap: 12px; box-shadow: 0 -4px 12px rgba(0,0,0,0.1); z-index: 100; }
        .binding-control-bar.active { display: flex; }
        .binding-info { font-size: 14px; font-weight: 600; color: #667eea; }
        .binding-control-btns { display: flex; gap: 8px; }
        .binding-control-btns button { padding: 8px 16px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .binding-confirm-btn { background: #10b981; color: white; }
        .binding-cancel-btn { background: #f3f4f6; color: #666; }
        .control-group { margin-bottom: 16px; }
        .control-group label { font-size: 14px; font-weight: 500; color: #555; margin-bottom: 6px; display: block; }
        .control-group select { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; }
        .control-group select:focus { outline: none; border-color: #667eea; }
        .results { display: none; }
        .teams-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .team-card { background: #f9fafb; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; }
        .team-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #e5e7eb; }
        .team-name { font-size: 22px; font-weight: 700; color: #667eea; }
        .team-count { background: #667eea; color: white; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600; }
        .team-members { list-style: none; }
        .team-members li { padding: 10px 0; color: #555; font-size: 14px; border-bottom: 1px solid #e5e7eb; }
        .team-members li:last-child { border-bottom: none; }
        .member-gender { display: inline-block; width: 18px; height: 18px; line-height: 18px; text-align: center; border-radius: 50%; font-size: 10px; font-weight: 600; margin-right: 6px; }
        .member-gender.female { background: #fce7f3; color: #ec4899; }
        .member-gender.male { background: #dbeafe; color: #3b82f6; }
        .info-box { background: #eff6ff; border: 2px solid #3b82f6; border-radius: 8px; padding: 14px; margin-top: 16px; }
        .info-box h4 { color: #1e40af; font-size: 15px; margin-bottom: 8px; }
        .info-box p { color: #1e40af; font-size: 13px; line-height: 1.6; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; background: white; border-radius: 12px; padding: 24px; }
        .alert-icon { font-size: 40px; text-align: center; margin-bottom: 12px; }
        .alert-card h3 { font-size: 18px; color: #333; margin-bottom: 10px; text-align: center; }
        .alert-card p { font-size: 14px; color: #666; line-height: 1.6; margin-bottom: 16px; text-align: center; }
        .alert-card.warning { border: 3px solid #ef4444; border-radius: 12px; padding: 16px; }
        .alert-buttons { display: flex; gap: 8px; justify-content: center; }
        .alert-buttons button { padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .alert-confirm-btn { background: #667eea; color: white; }
        .alert-cancel-btn { background: #f3f4f6; color: #666; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .header { padding: 20px; }
            .header h1 { font-size: 22px; }
            .content { padding: 16px; }
            .section { margin-bottom: 20px; }
            .section-title { font-size: 16px; }
            .import-container { flex-direction: column; }
            .import-btn { width: 100%; padding: 14px; }
            textarea { min-height: 140px; }
            .players-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
            .player-chip { padding: 10px 12px; }
            .gender-group { padding: 12px; }
            .binding-control-bar { padding: 18px 12px; }
            .binding-control-btns button { padding: 10px 18px; font-size: 14px; }
            .draw-btn { padding: 16px; font-size: 16px; }
            .teams-grid { grid-template-columns: 1fr; gap: 16px; }
            .team-card { padding: 16px; }
            .modal-content { width: 95%; padding: 20px; }
        }

        @media (max-width: 480px) {
            .header h1 { font-size: 20px; }
            .players-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 6px; }
            .player-chip { padding: 8px 10px; font-size: 12px; }
            .binding-info { font-size: 13px; }
            .gender-group-title { font-size: 14px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>球館臨打分籤系統</h1>
            <p>簡單 · 快速 · 公平</p>
        </div>

        <div class="content">
            <div class="section">
                <div class="section-title">參加者名單 (18人)</div>
                <div class="import-container">
                    <textarea id="importText" placeholder="請貼上名單，格式：姓名+性別（例如：王小明男、Amy女）&#10;每行一位參加者，共18人&#10;支援 Tab 分隔（從 Excel 複製）"></textarea>
                    <button class="import-btn" onclick="importPlayers()">匯入名單</button>
                </div>
                
                <div class="binding-groups" id="bindingGroups"></div>
                <div class="players-display" id="playersDisplay"></div>
            </div>

            <div class="section">
                <div class="section-title">場次設定</div>
                <div class="control-group">
                    <label>場次類別</label>
                    <select id="matchType">
                        <option value="女網混排">女網混排</option>
                        <option value="男網混排">男網混排</option>
                    </select>
                </div>
            </div>

            <div class="section">
                <button class="draw-btn" onclick="drawTeams()">
                    <span id="drawBtnText">開始分籤</span>
                </button>
            </div>

            <div class="results" id="results">
                <div class="section-title">分籤結果</div>
                <div class="teams-grid" id="teamsGrid"></div>
                
                <div class="info-box">
                    <h4>📋 賽制說明</h4>
                    <p>抽籤後請 A、B 兩隊先上場進行比賽。<br>C 隊成員請協助計分，並準備下一輪輪替。</p>
                </div>
            </div>
        </div>
    </div>

    <div class="binding-control-bar" id="bindingControlBar">
        <div class="binding-info" id="bindingInfo">已選擇 0 人</div>
        <div class="binding-control-btns">
            <button class="binding-cancel-btn" onclick="cancelBinding()">取消</button>
            <button class="binding-confirm-btn" onclick="confirmBinding()">確認綁定</button>
        </div>
    </div>

    <div class="modal" id="alertModal">
        <div class="modal-content">
            <div class="alert-card" id="alertCard">
                <div class="alert-icon" id="alertIcon">ℹ️</div>
                <h3 id="alertTitle">提示</h3>
                <p id="alertMessage"></p>
                <div class="alert-buttons" id="alertButtons">
                    <button class="alert-confirm-btn" onclick="closeAlert()">確認</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let players = [];
        let bindingGroups = [];
        let bindingMode = false;
        let currentBindingPlayer = null;
        let selectedPlayers = [];
        let hasShownBindingReminder = false;

        function importPlayers() {
            const text = document.getElementById('importText').value.trim();
            const lines = text.split('\n').filter(line => line.trim());

            if (lines.length !== 18) {
                showAlert('請確認名單共18人，目前有' + lines.length + '人', '⚠️');
                return;
            }

            players = [];

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                let name, gender;
                let parts = line.split(/[\t\s]+/);
                
                if (parts.length >= 2) {
                    let lastPart = parts[parts.length - 1];
                    if (lastPart === '男' || lastPart === '女') {
                        name = parts.slice(0, -1).join(' ');
                        gender = lastPart;
                    } else {
                        let lineNoSpace = line.replace(/\s+/g, '');
                        if (lineNoSpace.endsWith('男')) {
                            name = line.slice(0, line.lastIndexOf('男')).trim();
                            gender = '男';
                        } else if (lineNoSpace.endsWith('女')) {
                            name = line.slice(0, line.lastIndexOf('女')).trim();
                            gender = '女';
                        } else {
                            showAlert('第' + (i + 1) + '行格式錯誤：' + line, '⚠️');
                            return;
                        }
                    }
                } else {
                    let lineNoSpace = line.replace(/\s+/g, '');
                    if (lineNoSpace.endsWith('男')) {
                        name = line.slice(0, line.lastIndexOf('男')).trim();
                        gender = '男';
                    } else if (lineNoSpace.endsWith('女')) {
                        name = line.slice(0, line.lastIndexOf('女')).trim();
                        gender = '女';
                    } else {
                        showAlert('第' + (i + 1) + '行格式錯誤：' + line, '⚠️');
                        return;
                    }
                }

                if (!name || !gender) {
                    showAlert('第' + (i + 1) + '行格式錯誤：' + line, '⚠️');
                    return;
                }

                players.push({ name, gender, id: i });
            }

            renderPlayers();
            showAlert('✓ 名單匯入成功！共18人', '✅');
        }

        function renderPlayers() {
            const display = document.getElementById('playersDisplay');
            display.innerHTML = '';

            const unboundPlayers = players.filter(p => !isPlayerInGroup(p.id));
            const females = unboundPlayers.filter(p => p.gender === '女');
            const males = unboundPlayers.filter(p => p.gender === '男');

            if (females.length > 0) {
                const femaleGroup = document.createElement('div');
                femaleGroup.className = 'gender-group';
                femaleGroup.innerHTML = `
                    <div class="gender-group-header">
                        <div class="gender-group-title">
                            <div class="gender-icon female">♀</div>
                            <span>女生</span>
                        </div>
                        <div class="gender-count">${females.length} 人</div>
                    </div>
                    <div class="players-grid" id="femaleGrid"></div>
                `;
                display.appendChild(femaleGroup);

                const femaleGrid = femaleGroup.querySelector('#femaleGrid');
                females.forEach(player => femaleGrid.appendChild(createPlayerChip(player)));
            }

            if (males.length > 0) {
                const maleGroup = document.createElement('div');
                maleGroup.className = 'gender-group';
                maleGroup.innerHTML = `
                    <div class="gender-group-header">
                        <div class="gender-group-title">
                            <div class="gender-icon male">♂</div>
                            <span>男生</span>
                        </div>
                        <div class="gender-count">${males.length} 人</div>
                    </div>
                    <div class="players-grid" id="maleGrid"></div>
                `;
                display.appendChild(maleGroup);

                const maleGrid = maleGroup.querySelector('#maleGrid');
                males.forEach(player => maleGrid.appendChild(createPlayerChip(player)));
            }
        }

        function createPlayerChip(player) {
            const chip = document.createElement('div');
            chip.className = 'player-chip';

            if (bindingMode) {
                if (player.id === currentBindingPlayer) {
                    chip.classList.add('binding-active');
                } else {
                    chip.classList.add('selectable');
                    if (selectedPlayers.includes(player.id)) {
                        chip.classList.add('selected');
                    }
                    chip.onclick = () => togglePlayerSelection(player.id);
                }
            }

            const genderClass = player.gender === '女' ? 'female' : 'male';
            const genderSymbol = player.gender === '女' ? '♀' : '♂';

            chip.innerHTML = `
                <div class="gender-badge ${genderClass}">${genderSymbol}</div>
                <div class="player-name">${player.name}</div>
                ${!bindingMode ? `<div class="link-icon" onclick="startBinding(${player.id})">🔗</div>` : ''}
                ${bindingMode && player.id !== currentBindingPlayer ? '<div class="add-icon">+</div>' : ''}
            `;

            return chip;
        }

        function isPlayerInGroup(playerId) {
            return bindingGroups.some(group => group.members.includes(playerId));
        }

        function startBinding(playerId) {
            if (isPlayerInGroup(playerId)) {
                showAlert('此球友已在綁定群組中', '⚠️');
                return;
            }

            if (!hasShownBindingReminder) {
                showAlert('如為臨打場次，綁定隊友需徵得球友們的同意，確保大家都有良好的打球體驗喔！', 'ℹ️', true);
                hasShownBindingReminder = true;
                setTimeout(() => activateBindingMode(playerId), 100);
            } else {
                activateBindingMode(playerId);
            }
        }

        function activateBindingMode(playerId) {
            bindingMode = true;
            currentBindingPlayer = playerId;
            selectedPlayers = [];
            renderPlayers();
            updateBindingControlBar();
            document.getElementById('bindingControlBar').classList.add('active');
        }

        function togglePlayerSelection(playerId) {
            if (!bindingMode) return;

            const index = selectedPlayers.indexOf(playerId);
            if (index > -1) {
                selectedPlayers.splice(index, 1);
            } else {
                if (selectedPlayers.length >= 5) {
                    showAlert('一隊只有六個人，沒辦法綁定七個人喔！', '⚠️');
                    return;
                }
                selectedPlayers.push(playerId);
            }

            renderPlayers();
            updateBindingControlBar();
        }

        function updateBindingControlBar() {
            const totalSelected = selectedPlayers.length + 1;
            document.getElementById('bindingInfo').textContent = '已選擇 ' + totalSelected + ' 人';
        }

        function confirmBinding() {
            if (selectedPlayers.length === 0) {
                showAlert('請至少選擇一位隊友', '⚠️');
                return;
            }

            const allMembers = [currentBindingPlayer, ...selectedPlayers];
            const females = allMembers.filter(id => players.find(p => p.id === id).gender === '女').length;
            const males = allMembers.filter(id => players.find(p => p.id === id).gender === '男').length;

            const totalFemales = players.filter(p => p.gender === '女').length;
            const avgFemalesPerTeam = Math.ceil(totalFemales / 3);

            if (females > avgFemalesPerTeam) {
                showWarningAlert('女生數量高於其他隊伍，請提前告知其他球友喔！', () => {
                    createBindingGroup(allMembers, females, males);
                });
            } else {
                createBindingGroup(allMembers, females, males);
            }
        }

        function createBindingGroup(members, females, males) {
            bindingGroups.push({ members, females, males });
            exitBindingMode();
            renderBindingGroups();
            renderPlayers();
        }

        function cancelBinding() {
            exitBindingMode();
            renderPlayers();
        }

        function exitBindingMode() {
            bindingMode = false;
            currentBindingPlayer = null;
            selectedPlayers = [];
            document.getElementById('bindingControlBar').classList.remove('active');
        }

        function renderBindingGroups() {
            const container = document.getElementById('bindingGroups');
            container.innerHTML = '';

            bindingGroups.forEach((group, groupIndex) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'binding-group';

                const membersList = group.members.map(id => {
                    const player = players.find(p => p.id === id);
                    const genderClass = player.gender === '女' ? 'female' : 'male';
                    const genderSymbol = player.gender === '女' ? '♀' : '♂';
                    return `
                        <div class="binding-member">
                            <div class="gender-badge ${genderClass}">${genderSymbol}</div>
                            <span>${player.name}</span>
                            <button class="remove-member-btn" onclick="removeMemberFromGroup(${groupIndex}, ${id})">×</button>
                        </div>
                    `;
                }).join('');

                const warningText = group.members.length === 6 
                    ? '<div class="full-team-warning">⚠️ 因為已經綁定六人同隊，抽籤將自動列入低順位，將維持在C隊喔</div>'
                    : '';

                groupDiv.innerHTML = `
                    <div class="binding-group-header">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <div class="binding-group-title">🔗 綁定群組 ${groupIndex + 1}</div>
                            <div class="gender-stats">${group.females}女 ${group.males}男</div>
                        </div>
                        <button class="remove-group-btn" onclick="removeBindingGroup(${groupIndex})">解散群組</button>
                    </div>
                    <div class="binding-members">${membersList}</div>
                    ${warningText}
                `;

                container.appendChild(groupDiv);
            });
        }

        function removeMemberFromGroup(groupIndex, playerId) {
            const group = bindingGroups[groupIndex];
            group.members = group.members.filter(id => id !== playerId);

            const player = players.find(p => p.id === playerId);
            if (player.gender === '女') {
                group.females--;
            } else {
                group.males--;
            }

            if (group.members.length === 0) {
                bindingGroups.splice(groupIndex, 1);
            }

            renderBindingGroups();
            renderPlayers();
        }

        function removeBindingGroup(groupIndex) {
            bindingGroups.splice(groupIndex, 1);
            renderBindingGroups();
            renderPlayers();
        }

        function drawTeams() {
            if (players.length !== 18) {
                showAlert('請先匯入18位參加者名單！', '⚠️');
                return;
            }

            const matchType = document.getElementById('matchType').value;
            let teamA = [], teamB = [], teamC = [];

            const fullTeamGroups = bindingGroups.filter(g => g.members.length === 6);
            const partialGroups = bindingGroups.filter(g => g.members.length < 6);

            if (fullTeamGroups.length === 1) {
                teamC = fullTeamGroups[0].members.map(id => players.find(p => p.id === id));
            } else if (fullTeamGroups.length >= 2) {
                const shuffledFull = fullTeamGroups.sort(() => Math.random() - 0.5);
                teamA = shuffledFull[0].members.map(id => players.find(p => p.id === id));
                teamB = shuffledFull[1].members.map(id => players.find(p => p.id === id));
                if (shuffledFull[2]) {
                    teamC = shuffledFull[2].members.map(id => players.find(p => p.id === id));
                }
            }

            const teams = [teamA, teamB, teamC].filter(t => t.length === 0);
            const shuffledPartial = partialGroups.sort(() => Math.random() - 0.5);

            shuffledPartial.forEach(group => {
                if (teams.length > 0) {
                    const targetTeam = teams.shift();
                    targetTeam.push(...group.members.map(id => players.find(p => p.id === id)));
                    if (targetTeam === teamA) teamA = targetTeam;
                    else if (targetTeam === teamB) teamB = targetTeam;
                    else teamC = targetTeam;
                    if (targetTeam.length < 6) teams.push(targetTeam);
                }
            });

            const boundPlayerIds = bindingGroups.flatMap(g => g.members);
            const unboundPlayers = players.filter(p => !boundPlayerIds.includes(p.id));

            if (matchType === '女網混排') {
                fillTeamsWomenMix(teamA, teamB, teamC, unboundPlayers);
            } else {
                fillTeamsMenMix(teamA, teamB, teamC, unboundPlayers);
            }

            displayTeams(teamA, teamB, teamC);
        }

        function fillTeamsWomenMix(teamA, teamB, teamC, unboundPlayers) {
            const females = unboundPlayers.filter(p => p.gender === '女').sort(() => Math.random() - 0.5);
            const males = unboundPlayers.filter(p => p.gender === '男').sort(() => Math.random() - 0.5);
            const teams = [teamA, teamB, teamC];

            while (females.length > 0 || males.length > 0) {
                for (let team of teams) {
                    if (team.length < 6) {
                        const femaleCount = team.filter(p => p.gender === '女').length;
                        const needMoreFemales = femaleCount < 2 && females.length > 0;

                        if (needMoreFemales && females.length > 0) {
                            team.push(females.shift());
                        } else if (males.length > 0) {
                            team.push(males.shift());
                        } else if (females.length > 0) {
                            team.push(females.shift());
                        }
                    }
                }
            }
        }

        function fillTeamsMenMix(teamA, teamB, teamC, unboundPlayers) {
            const shuffled = unboundPlayers.sort(() => Math.random() - 0.5);
            const teams = [teamA, teamB, teamC];

            shuffled.forEach(player => {
                for (let team of teams) {
                    if (team.length < 6) {
                        team.push(player);
                        break;
                    }
                }
            });
        }

        function displayTeams(teamA, teamB, teamC) {
            const teams = [
                { name: 'A隊', members: teamA },
                { name: 'B隊', members: teamB },
                { name: 'C隊', members: teamC }
            ];

            const grid = document.getElementById('teamsGrid');
            grid.innerHTML = '';

            teams.forEach(team => {
                const card = document.createElement('div');
                card.className = 'team-card';
                
                const sortedMembers = team.members.sort((a, b) => {
                    if (a.gender === '女' && b.gender === '男') return -1;
                    if (a.gender === '男' && b.gender === '女') return 1;
                    return 0;
                });
                
                const membersList = sortedMembers.map(m => {
                    const genderClass = m.gender === '女' ? 'female' : 'male';
                    const genderSymbol = m.gender === '女' ? '♀' : '♂';
                    return `
                        <li>
                            <span class="member-gender ${genderClass}">${genderSymbol}</span>
                            ${m.name}
                        </li>
                    `;
                }).join('');

                card.innerHTML = `
                    <div class="team-header">
                        <div class="team-name">${team.name}</div>
                        <div class="team-count">${team.members.length}人</div>
                    </div>
                    <ul class="team-members">${membersList}</ul>
                `;
                grid.appendChild(card);
            });

            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('drawBtnText').textContent = '🔄 重新分籤';
        }

        function showAlert(message, icon, isInfo = false) {
            document.getElementById('alertIcon').textContent = icon;
            document.getElementById('alertTitle').textContent = isInfo ? '溫馨提醒' : '提示';
            document.getElementById('alertMessage').textContent = message;
            
            const alertCard = document.getElementById('alertCard');
            alertCard.classList.remove('warning');
            
            document.getElementById('alertButtons').innerHTML = '<button class="alert-confirm-btn" onclick="closeAlert()">確認</button>';
            document.getElementById('alertModal').style.display = 'block';
        }

        function showWarningAlert(message, onConfirm) {
            document.getElementById('alertIcon').textContent = '⚠️';
            document.getElementById('alertTitle').textContent = '警告';
            document.getElementById('alertMessage').textContent = message;
            
            const alertCard = document.getElementById('alertCard');
            alertCard.classList.add('warning');
            
            document.getElementById('alertButtons').innerHTML = `
                <button class="alert-cancel-btn" onclick="closeAlert()">取消</button>
                <button class="alert-confirm-btn" onclick="confirmWarning()">確認繼續</button>
            `;
            
            window.pendingConfirm = onConfirm;
            document.getElementById('alertModal').style.display = 'block';
        }

        function confirmWarning() {
            closeAlert();
            if (window.pendingConfirm) {
                window.pendingConfirm();
                window.pendingConfirm = null;
            }
        }

        function closeAlert() {
            document.getElementById('alertModal').style.display = 'none';
            document.getElementById('alertCard').classList.remove('warning');
        }
    </script>
</body>
</html>